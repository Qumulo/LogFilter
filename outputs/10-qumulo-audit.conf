# +-+-+-+-+-+-+ +-+-+ +-+-+-+ +-+-+-+-+-+ +-+-+-+-+ +-+-+-+-+-+ +-+-+-+-+-+-+-+-+-+-+-+ 
# |P|L|E|A|S|E| |D|O| |N|O|T| |T|O|U|C|H| |T|H|I|S| |F|I|L|E|S| |M|A|N|U|A|L|L|Y|!|!|!| 
# +-+-+-+-+-+-+ +-+-+ +-+-+-+ +-+-+-+-+-+ +-+-+-+-+ +-+-+-+-+-+ +-+-+-+-+-+-+-+-+-+-+-+

# Log message format: "timestamp,audit-msg-csv-fields..."

template(name="QumuloAuditFormat" type="list")
{
  property(name="timestamp" dateFormat="rfc3339")
  constant(value=",")
  property(name="hostname")
  constant(value=",")
  property(name="msg")
  constant(value="\n")
}

# 2022-03-11T00:14:48.707799Z,10.100.246.152,"admin",api,nfs_delete_export,ok,9,"/PSS",""

set $!client_ips = field($msg, 44 ,1);
set $!users = field($msg, 44 ,2);
set $!protocols = field($msg, 44 ,3);
set $!operations = field($msg, 44 ,4);
set $!results = field($msg, 44 ,5);
set $!ids = field($msg, 44 ,6);
set $!file_path_1s = field($msg, 44 ,7);
set $!file_path_2s = field($msg, 44 ,8);

# Log file directory specifications

template(name="AuditLog1" type="list")
{
    constant(value="/var/log/qumulo/auditlog1/")
    property(name="hostname")
    constant(value=".log")
}

template(name="AuditLog2" type="list")
{
    constant(value="/var/log/qumulo/auditlog2/")
    property(name="hostname")
    constant(value=".log")
}

template(name="AuditLog3" type="list")
{
    constant(value="/var/log/qumulo/auditlog3/")
    property(name="hostname")
    constant(value=".log")
}

# Log filtering rules generated by LogFilter

if ($app-name startswith "qumulo") then
{
    if
    (
        (
            $!protocols contains "nfs3" 
        )
    )
    then
    {
        action(type="omfwd" target="192.168.102.10" port="514" protocol="udp" template="QumuloAuditFormat")
        action(type="omfile" dynaFile="AuditLog1" template="QumuloAuditFormat")
    }
    else
    {
        action(type="omfile" file="/dev/null" template="QumuloAuditFormat")
    }
}

# Log filtering rules generated by LogFilter

if ($app-name startswith "qumulo") then
{
    if
    (
        not
        (
            $!operations contains "fs_delete" 
        )
    )
    then
    {
        action(type="omfwd" target="192.168.102.11" port="514" protocol="tcp" template="QumuloAuditFormat")
        action(type="omfile" dynaFile="AuditLog2" template="QumuloAuditFormat")
    }
    else
    {
        action(type="omfile" file="/dev/null" template="QumuloAuditFormat")
    }
}

# Log filtering rules generated by LogFilter

if ($app-name startswith "qumulo") then
{
    if
    (
        (
            $!operations contains "fs_delete" or 
            $!operations contains "fs_write" or 
            $!operations contains "fs_read" 
        )
    )
    then
    {
        action(type="omfwd" target="192.168.102.12" port="514" protocol="tcp" template="QumuloAuditFormat")
        action(type="omfile" dynaFile="AuditLog3" template="QumuloAuditFormat")
    }
    else
    {
        action(type="omfile" file="/dev/null" template="QumuloAuditFormat")
    }
}
